#!/bin/bash


SCRIPT=$(readlink -f "$0")
BIN=$(dirname $SCRIPT)

TEST_DIR="$BIN/../"
SETTINGS=$TEST_DIR/settings.json

if [ -n "$1" ]; then
	TEST_ENVIRONMENT=$1
else
	TEST_ENVIRONMENT=browserstack
fi

if [ "$TEST_ENVIRONMENT" = "browserstack" ]; then
	OPEN_TUNNEL=true
else
	OPEN_TUNNEL=false
fi

### BROWSERSTACK SETTINGS

BROWSERSTACK=$BIN/BrowserStackLocal
AUTH_KEY=hUekxaVKYy6ygeaBTn5z

HOST=localhost
PORT=9000

WAIT_FILE="/tmp/ww-nightwatch-$$-bs-status"

### ====

npm install

cd $TEST_DIR

if [ "$OPEN_TUNNEL" = true ]; then
	echo "Opening tunnel..."
	$BROWSERSTACK $AUTH_KEY $HOST,$PORT,0 &> $WAIT_FILE &
	touch $WAIT_FILE

	# Wait for BrowserStack tunnel to start before running tests
	while grep "Press Ctrl-C" $WAIT_FILE; do sleep 0.2; done
fi

# Run tests!
$BIN/nightwatch --config $SETTINGS -e $TEST_ENVIRONMENT $TEST_DIR